<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°—Ç–µ–Ω–¥ —Ç—è–≥–∏</title>

  <!-- Chart.js ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Tailwind CSS ‚Äî —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide ‚Äî –∏–∫–æ–Ω–∫–∏ -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-900 text-white font-sans p-4">
    <div class="flex gap-4">
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="flex flex-col gap-2 pt-1">
          <a href="/" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">
            <i data-lucide="activity"></i><span>–ó–∞–º–µ—Ä—ã</span>
          </a>
          <a href="/results" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">
            <i data-lucide="file-text"></i><span>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</span>
          </a>
        </div>
      
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="flex-1 space-y-4">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <h1 class="text-2xl font-bold flex items-center gap-2">
      –ò–∑–º–µ—Ä–µ–Ω–∏–µ —Ç—è–≥–∏
      <div id="statusIndicator" class="w-3 h-3 bg-green-500 rounded-full animate-pulse hidden"></div>
    </h1>

    <!-- –°–µ–∫—Ü–∏—è: –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 bg-gray-800 rounded-xl p-4 shadow-md">
    <div class="space-y-2">
      <h2 class="text-lg font-semibold">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h2>
      <input id="motorInput" class="w-full bg-gray-700 text-white p-2 rounded" placeholder="–ú–æ—Ç–æ—Ä" value="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–æ—Ç–æ—Ä">
      <input id="propInput" class="w-full bg-gray-700 text-white p-2 rounded" placeholder="–ü—Ä–æ–ø–µ–ª–ª–µ—Ä" value="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–ø–µ–ª–ª–µ—Ä">
      <input id="batteryInput" class="w-full bg-gray-700 text-white p-2 rounded" placeholder="–ë–∞—Ç–∞—Ä–µ—è" value="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è">
    </div>
  
  </div>

    <!-- –û–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
      <canvas id="chart" class="w-full h-60"></canvas>
      <p id="pauseLabel" class="text-center text-yellow-400 mt-2 hidden">‚è∏ –ü–∞—É–∑–∞ - –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</p>
      <p id="autoPauseLabel" class="text-center text-yellow-400 mt-2 hidden">‚è∏ –ü–∞—É–∑–∞ ‚Äî –Ω–µ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏</p>
      <p id="hxError" class="text-center text-red-500 mt-2 hidden">‚ùå –û—à–∏–±–∫–∞: –≤–µ—Å—ã (HX711) –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã</p>
      <p id="serverError" class="text-center text-red-500 mt-2 hidden">‚ùå –û—à–∏–±–∫–∞: –¢—è–≥–æ–º–µ—Ç—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç</p>
    </div>

    <!-- –†–µ–≥—É–ª—è—Ç–æ—Ä PWM -->
  <div class="bg-gray-800 rounded-xl p-4 shadow-md mt-4">
    <h2 class="text-lg font-semibold mb-2">PWM —Å–∏–≥–Ω–∞–ª</h2>
    <label for="thrustSlider" class="block text-sm text-gray-300 mb-1">–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: <span id="thrustValue">1000</span> –º–∫—Å</label>
    <input id="thrustSlider" type="range" min="1000" max="2000" value="1000" step="1" class="w-full">
  </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="flex flex-wrap gap-2 justify-center mt-4 text-sm sm:text-base">
      <button id="startPauseBtn" onclick="toggleMeasurement()" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg font-semibold">
        <i data-lucide="play"></i><span>–°—Ç–∞—Ä—Ç</span>
      </button>
      <button id="stopBtn" onclick="stopTest()" disabled class="opacity-50 pointer-events-none flex items-center gap-2 bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg font-semibold">
        <i data-lucide="stop-circle"></i>–°—Ç–æ–ø
      </button>
      <button id="resetBtn" onclick="resetTest()" disabled class="opacity-50 pointer-events-none flex items-center gap-2 bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded-lg font-semibold">
        <i data-lucide="rotate-ccw"></i>–°–±—Ä–æ—Å
  </button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="resultsButtons" class="flex flex-wrap gap-2 justify-center mt-4 text-sm sm:text-base hidden">
      <button onclick="exportResults()" class="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-700 px-3 py-2 rounded-lg font-semibold">
        <i data-lucide="file-text"></i>CSV
      </button>
      <button onclick="downloadChart()" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg font-semibold">
        <i data-lucide="image"></i>–ì—Ä–∞—Ñ–∏–∫
      </button>
    </div>

    <!-- –¢–µ–∫—É—â–∏–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å -->
    <div class="grid grid-cols-2 gap-4 mt-6">
        <div class="bg-gray-800 rounded-xl p-4 shadow-md col-span-2">
            <p class="text-lg">–í—Ä–µ–º—è:</p>
            <p class="font-mono text-2xl text-blue-400" id="elapsedTime">0.0 —Å–µ–∫.</p>
          </div>
      <div class="bg-gray-800 rounded-xl p-4 shadow-md">
        <p class="text-lg">–¢–µ–∫—É—â–∞—è —Ç—è–≥–∞:</p>
        <p class="font-mono text-2xl text-blue-400" id="weight">0.00</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 shadow-md">
        <p class="text-lg">–ú–∞–∫—Å–∏–º—É–º:</p>
        <p class="font-mono text-2xl text-yellow-400" id="maxWeight">0.00</p>
      </div>
    </div> <!-- –∫–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
</div> <!-- –∫–æ–Ω–µ—Ü flex -->

<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫
  lucide.createIcons();

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
  const ctx = document.getElementById('chart').getContext('2d');
  const data = {
    labels: [],  // –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    datasets: [{
      label: '–¢—è–≥–∞ (–≥)',
      data: [], // –∑–Ω–∞—á–µ–Ω–∏—è —Ç—è–≥–∏
      borderColor: 'rgb(59, 130, 246)',
      backgroundColor: 'rgba(59, 130, 246, 0.1)',
      tension: 0.3 // —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏
    },
    {
      label: 'PWM',
      data: [],
      borderColor: 'rgb(34, 197, 94)', // –∑–µ–ª—ë–Ω—ã–π
      backgroundColor: 'rgba(34, 197, 94, 0.1)',
      tension: 0.3,
      yAxisID: 'y2'
    }
    ]
  };

  const chart = new Chart(ctx, {
    type: 'line',
    data: data,
    options: {
  animation: false,
  scales: {
    y: {
      beginAtZero: true,
      ticks: { color: "#fff" },
      grid: { color: "#444" },
      title: { display: true, text: '–¢—è–≥–∞ (–≥)', color: "#fff" }
    },
    y2: {
      position: 'right',
      min: 1000,
      max: 2000,
      ticks: { color: "#22c55e" },
      grid: { drawOnChartArea: false },
      title: { display: true, text: 'PWM', color: "#22c55e" }
    },
    x: {
      type: 'linear',
      min: 0,
      max: 15,
      ticks: { color: "#aaa" },
      grid: { color: "#333" }
    }
  },
  plugins: {
    legend: { labels: { color: "#fff" } }
  }
}
  });

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ —Ç—è–≥–∏ (PWM)
document.getElementById("thrustSlider").addEventListener("input", (e) => {
  const pwm = parseInt(e.target.value); // –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 1000 –¥–æ 2000
  currentPWM = pwm; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
  document.getElementById("thrustValue").textContent = `${pwm} –º–∫—Å`;

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ ESP32
  fetch(`/thrust?value=${pwm}`).catch(err => {
    console.warn("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PWM:", err);
  });
});

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  let isRunning = false;
  let isPaused = false;
  let autoPaused = false;
  let startTime = 0;
  let maxWeight = 0;
  let lastWeight = 0;
  let unchangedSeconds = 0;

  let measurementStartTime = null;
  let accumulatedTime = 0; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  let lastResumeTime = null;
  let currentPWM = 1000;

  let currentCsvPath = ""; //–¥–ª—è —Ñ–∞–π–ª–æ–≤

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞/–ø–∞—É–∑—ã –∏–∑–º–µ—Ä–µ–Ω–∏–π
  function toggleMeasurement() {

   const btn = document.getElementById("startPauseBtn");
   const icon = btn.querySelector("i");
   const text = btn.querySelector("span");

  if (!isRunning) {
    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
    document.getElementById("stopBtn").disabled = false;
    document.getElementById("stopBtn").classList.remove("opacity-50", "pointer-events-none");
    document.getElementById("elapsedTime").textContent = "0.0 —Å–µ–∫.";
    isRunning = true;
    isPaused = false;
    autoPaused = false;
    measurementStartTime = Date.now(); // –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    maxWeight = 0;
    lastWeight = 0;
    unchangedSeconds = 0;
    accumulatedTime = 0;
    lastResumeTime = Date.now();

    // –û—á–∏—Å—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.options.scales.x.min = 0;
    chart.options.scales.x.max = 15;
    chart.update();

    // –°–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏–π
    document.getElementById("weight").textContent = "0.00";
    document.getElementById("maxWeight").textContent = "0.00";
    document.getElementById("pauseLabel").classList.add("hidden");
    document.getElementById("autoPauseLabel").classList.add("hidden");
    document.getElementById("resultsButtons").classList.add("hidden");
    document.getElementById("elapsedTime").textContent = "0.0 —Å–µ–∫.";

    fetch("/tare");

    // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –∏ —Ç–µ–∫—Å—Ç
    replaceIcon(btn, "pause", "–ü–∞—É–∑–∞");

  } else if (isPaused || autoPaused) {
    // –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    isPaused = false;
    autoPaused = false;
    lastResumeTime = Date.now();
    document.getElementById("pauseLabel").classList.add("hidden");
    document.getElementById("autoPauseLabel").classList.add("hidden");

    replaceIcon(btn, "pause", "–ü–∞—É–∑–∞");

  } else {
    // –í—Ä—É—á–Ω—É—é –ø–∞—É–∑–∞
    isPaused = true;
    document.getElementById("pauseLabel").classList.remove("hidden");
    document.getElementById("autoPauseLabel").classList.add("hidden"); // üîß –°–∫—Ä—ã—Ç—å –∞–≤—Ç–æ-–ø–∞—É–∑—É –ø—Ä–∏ —Ä—É—á–Ω–æ–π
    replaceIcon(btn, "play", "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å");
    accumulatedTime += (Date.now() - lastResumeTime) / 1000;
    lastResumeTime = null;
  }
}

// üëá –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∑–∞–º–µ–Ω—ã –∏–∫–æ–Ω–∫–∏
function replaceIcon(button, iconName, text) {
  button.innerHTML = `<i data-lucide="${iconName}"></i><span>${text}</span>`;
  lucide.createIcons();
}

  // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
  function stopTest() {
  isRunning = false;
  isPaused = false;
  autoPaused = false;
  measurementStartTime = null;
  accumulatedTime = 0;
  lastResumeTime = null; 

  // –°–±—Ä–æ—Å –ø–æ–ª–∑—É–Ω–∫–∞ PWM
document.getElementById("thrustSlider").value = 1000;
document.getElementById("thrustValue").textContent = "1000 –º–∫—Å";
currentPWM = 1000;
fetch(`/thrust?value=1000`);


  // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
  document.getElementById("pauseLabel").classList.add("hidden");
  document.getElementById("autoPauseLabel").classList.add("hidden");
  document.getElementById("resultsButtons").classList.remove("hidden");
  document.getElementById("statusIndicator").classList.add("hidden");
  document.getElementById("elapsedTime").textContent = "0.0 —Å–µ–∫.";
  

  // –û–±–Ω—É–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
  document.getElementById("weight").textContent = "0.00";
  document.getElementById("maxWeight").textContent = "0.00";

  // –ö–Ω–æ–ø–∫–∞ "–°—Ç–∞—Ä—Ç"
  const btn = document.getElementById("startPauseBtn");
  replaceIcon(btn, "play", "–°—Ç–∞—Ä—Ç");

  // –û—Ç–∫–ª—é—á–∞–µ–º "–°—Ç–æ–ø"
  const stopBtn = document.getElementById("stopBtn");
  stopBtn.disabled = true;
  stopBtn.classList.add("opacity-50", "pointer-events-none");

// –ü–æ—Å–ª–µ stopBtn –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
document.getElementById("startPauseBtn").disabled = true; // –∑–∞–ø—Ä–µ—Ç –Ω–∞ —Å—Ç–∞—Ä—Ç –¥–æ —Å–±—Ä–æ—Å–∞
const startBtn = document.getElementById("startPauseBtn");
startBtn.classList.add("opacity-50", "pointer-events-none");
startBtn.disabled = true;

  // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
const resetBtn = document.getElementById("resetBtn");
resetBtn.disabled = false;
resetBtn.classList.remove("opacity-50", "pointer-events-none");
}

  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –≤–µ—Å–∞ –∫–∞–∂–¥—ã–µ 500 –º—Å
  setInterval(() => {
  fetch("/weight")
    .then(res => res.json())
    .then(data => {
      let time = accumulatedTime;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ (–Ω–µ –ø–∞—É–∑–∞, –Ω–µ –∞–≤—Ç–æ-–ø–∞—É–∑–∞)
      if (isRunning && lastResumeTime !== null) {
        time += (Date.now() - lastResumeTime) / 1000;
      }

      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è (–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤ –∞–≤—Ç–æ-–ø–∞—É–∑–µ!)
      document.getElementById("elapsedTime").textContent = `${time.toFixed(1)} —Å–µ–∫.`;

      const weight = parseFloat(data.weight);

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å
      document.getElementById("weight").textContent = weight.toFixed(2);
      document.getElementById("statusIndicator").classList.remove("hidden");
      document.getElementById("hxError").classList.add("hidden");

      // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –ø–∞—É–∑–µ
      if (!isRunning || isPaused || autoPaused) {
        document.getElementById("statusIndicator").classList.add("hidden");
        return;
      }

      // –ú–∞–∫—Å–∏–º—É–º
      if (weight > maxWeight) {
        maxWeight = weight;
        document.getElementById("maxWeight").textContent = maxWeight.toFixed(2);
      }

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      if (Math.abs(weight - lastWeight) < 0.01 || weight < 0.07) {
        unchangedSeconds += 0.5;
      } else {
        unchangedSeconds = 0;
      }

      lastWeight = weight;

// –£—Å–ª–æ–≤–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–∞—É–∑—ã
if (unchangedSeconds > 3 && currentPWM < 1000 && weight < 100) {
  if (!autoPaused) {
    autoPaused = true;
    isPaused = false;

    if (lastResumeTime !== null) {
      accumulatedTime += (Date.now() - lastResumeTime) / 1000;
    }
    lastResumeTime = null;

    document.getElementById("autoPauseLabel").classList.remove("hidden");
    document.getElementById("startPauseBtn").querySelector("span").textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
    document.getElementById("startPauseBtn").querySelector("i").setAttribute("data-lucide", "play");
    lucide.createIcons();
  }
  return;
}

// üîÅ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–Ω—è—Ç–∏–µ –∞–≤—Ç–æ-–ø–∞—É–∑—ã
if (autoPaused && (weight > 100 || currentPWM >= 1000)) {
  autoPaused = false;
  isPaused = false;
  lastResumeTime = Date.now();
  document.getElementById("autoPauseLabel").classList.add("hidden");
  replaceIcon(document.getElementById("startPauseBtn"), "pause", "–ü–∞—É–∑–∞");
}

      // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
      chart.data.labels.push(parseFloat(time));
      chart.data.datasets[0].data.push(weight);
      chart.data.datasets[1].data.push(currentPWM);

      if (chart.data.labels.length > 0 && chart.data.labels[chart.data.labels.length - 1] > 15) {
        chart.options.scales.x.min = chart.data.labels[chart.data.labels.length - 1] - 15;
        chart.options.scales.x.max = chart.data.labels[chart.data.labels.length - 1];
      }

      chart.update();
    })
    .catch(() => {
      document.getElementById("hxError").classList.remove("hidden");
    });
}, 500);

  // –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ CSV
  function exportResults() {
    let csv = "time,weight\n";
    for (let i = 0; i < chart.data.labels.length; i++) {
      csv += `${chart.data.labels[i]},${chart.data.datasets[0].data[i]}\n`;
    }
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    const now = new Date();
    const filename = `${now.toISOString().slice(0,10)}-${chart.data.labels.length}s-${maxWeight.toFixed(0)}g.csv`;
    link.download = filename;
    link.href = URL.createObjectURL(blob);
    link.click();
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞–∫ PNG
  function downloadChart() {
    const link = document.createElement("a");
    link.download = "chart.png";
    link.href = chart.toBase64Image();
    link.click();
  }

  function resetTest() {

    currentCsvPath = ""; //—Å–±—Ä–æ—Å —Ñ–∞–π–ª–∞

  // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
  chart.data.labels = [];
  chart.data.datasets[0].data = [];
  chart.data.datasets[1].data = [];
  chart.options.scales.x.min = 0;
  chart.options.scales.x.max = 15;
  chart.update();

  // –°–±—Ä–æ—Å –≤—Å–µ—Ö –ø–æ–ª–µ–π
  document.getElementById("weight").textContent = "0.00";
  document.getElementById("maxWeight").textContent = "0.00";
  document.getElementById("elapsedTime").textContent = "0.0 —Å–µ–∫.";
  document.getElementById("pauseLabel").classList.add("hidden");
  document.getElementById("autoPauseLabel").classList.add("hidden");
  document.getElementById("statusIndicator").classList.add("hidden");
  document.getElementById("resultsButtons").classList.add("hidden");

  // –°–±—Ä–æ—Å –ø–æ–ª–∑—É–Ω–∫–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏—è PWM
  document.getElementById("thrustSlider").value = 1000;
  document.getElementById("thrustValue").textContent = "1000 –º–∫—Å";
  currentPWM = 1000;
  fetch(`/thrust?value=1000`);

  // –í–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ä—Ç, –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–±—Ä–æ—Å
  const startBtn = document.getElementById("startPauseBtn");
  replaceIcon(startBtn, "play", "–°—Ç–∞—Ä—Ç");
  startBtn.classList.remove("opacity-50", "pointer-events-none");
  startBtn.disabled = false;

  const resetBtn = document.getElementById("resetBtn");
  resetBtn.disabled = true;
  resetBtn.classList.add("opacity-50", "pointer-events-none");
}

  
</script>
</body>
</html>